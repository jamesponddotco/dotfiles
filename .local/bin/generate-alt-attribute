#!/usr/bin/env bash
#
# Script Name: Generate Alt Attribute
# Script URL: https://git.sr.ht/~jamesponddotco/dotfiles
# Description: Use artificial intelligence to generate an image description.
# Version: 0.1.0
# Author: James Pond
# Author URL: https://jamespond.co/
# License: European Union Public License 1.2 or later
# License URI: https://joinup.ec.europa.eu/collection/eupl/eupl-text-11-12
#

# Enable "bash strict mode".
# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -euo pipefail
IFS=$'\n\t'

# Force all output to use the simplest locale. Fix issues with macOS.
readonly LC_ALL='C'

# Get the API key for Azure Computer Vision.
azure_api_key="$(1p get item 'Microsoft Azure' --fields cv-api)"

# Store the endpoint from Azure inside a variable, to make it easier to replace
# when needed.
azure_endpoint='https://westeurope.api.cognitive.microsoft.com'

# Upload the image using cURL.
curl "$azure_endpoint/vision/v1.0/describe?maxCandidates=1" \
  --tlsv1.2 \
  --proto '=https' \
  --silent \
  --request POST \
  --header 'Content-Type: application/octet-stream' \
  --header "Ocp-Apim-Subscription-Key: $azure_api_key" \
  --upload-file "$1" \
  | jq --raw-output '.description.captions[].text'

# All was well.
exit 0
