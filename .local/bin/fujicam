#!/bin/bash
#
# Script Name: Fujicam
# Script URL: https://git.sr.ht/~jamesponddotco/dotfiles
# Description: Use my Fujifilm X-T3 camera as my webcam.
# Version: 1.0.0
# Author: James Pond
# Author URL: https://jamespond.co/
# License: European Union Public License 1.2 or later
# License URI: https://joinup.ec.europa.eu/collection/eupl/eupl-text-11-12
#

# Enable "bash strict mode".
# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -euo pipefail
IFS=$'\n\t'

# Enable the kernel module for v4l2loopback, a virtual video device.
sudo modprobe v4l2loopback exclusive_caps=1 max_buffers=2 card_label="Fujicam"

# Make sure that we do not run into the "Could not claim the USB device" error.
pkill -f gphoto2

# The magic happens here. Use gphoto2 to capture a video using the camera, and
# then feed the output to ffmpeg, which in turn uses v4l2loopback to create,
# and display a webcam.
gphoto2 --stdout --capture-movie \
  | ffmpeg -i - -vcodec rawvideo -pix_fmt yuv420p -threads 0 \
    -video_size 1280x720 -f v4l2 /dev/video0

# All was well.
exit 0
