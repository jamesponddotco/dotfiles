#!/usr/bin/env bash
#
# Script Name: Firefox
# Script URL: https://git.sr.ht/~jamesponddotco/dotfiles
# Description: Wrapper to start Firefox inside a Firejail sandbox.
# Version: 0.1.0
# Author: James Pond
# Author URL: https://jamespond.co/
# License: European Union Public License 1.2 or later
# License URI: https://joinup.ec.europa.eu/collection/eupl/eupl-text-11-12
#

# Configure bash to work in "strict mode" to make it more robust, reliable and
# maintainable, like some other languages.
set -o errexit -o errtrace -o pipefail -o nounset
shopt -s nullglob
unset CDPATH
IFS=$'\n\t'
LC_ALL='C'

# If trying to browse the web in private, start Firefox inside a sandbox with a
# new profile and home directory.
#
# @TODO: Configure and move a started profile so we don't have to lose time
# configuring extensions, the browser, and whatnot.
if [[ "${1:-}" == '--private' ]]; then
  temporary_profile_directory="$(mktemp --directory --quiet)"
  readonly temporary_profile_directory

  firejail \
    --quiet \
    --name='Firefox (Private Window)' \
    --env=name='LD_PRELOAD=/usr/lib64/libhardened_malloc.so' \
    --apparmor \
    --seccomp \
    --restrict-namespaces \
    --caps.drop=all \
    --novideo \
    --nonewprivs \
    --nou2f \
    --machine-id \
    --private="${temporary_profile_directory}" \
    --private-tmp \
    --private-cache \
    --private-dev \
    --private-cwd \
    --profile='/etc/firejail/firefox.profile' \
    /usr/bin/firefox --no-remote --private-window
else
  /usr/bin/firefox "${@}"
fi

# All was well.
exit 0
